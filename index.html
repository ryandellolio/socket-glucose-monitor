<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading...</title>
  </head>
  <body>
    <div id="main">Loading...</div>
    <div id="next">Loading...</div>
    <div id="countdown">Loading...</div>

    <div style="width: 400px; height: 400px">
      <canvas id="myChart" width="400" height="400"></canvas>
    </div>
    <script
      src="https://cdn.socket.io/4.3.2/socket.io.min.js"
      integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"
      integrity="sha512-GMGzUEevhWh8Tc/njS0bDpwgxdCJLQBWG3Z2Ct+JGOpVnEmjvNx6ts4v6A2XJf1HOrtOsfhv3hBKpK9kE5z8AQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
      integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.1.0/chartjs-plugin-annotation.min.js"
      integrity="sha512-uxcl+YXF0LbFyZFEb6HHmxl1NEI4X/5rjojm/13M1CBXBDj8wkmM99cKADkmtuky28pC/EpNTDHOEb/c3nDZsA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="/js/chart.js"></script>
    <script src="/js/document-title.js"></script>
    <script src="/js/countdown.js"></script>
    <script>
      var socket = io();

      $(document).ready(function () {
        socket.on("disconnect", () => {
          console.log(socket.id); // undefined
          myChart.destroy();
        });

        socket.on("retro", function (history) {
          i = history.length - 1;
          while (i > 0) {
            //drop the last reading by stopping at 1.  There will be emit of most recent reading outside of retro emission
            myChart.data.labels.push(
              moment(history[i].dateString).format("hh:mm a")
            );
            myChart.data.datasets[0].data.push(history[i].sgv);
            i = i - 1;
          }
          console.log(history);
        });

        socket.on("reading", function (msg) {
          $("#main").html("Reading: " + msg.sgv + " mg/dL");
          $(document).prop("title", generateTitle(msg));
          $("#next").html(
            "Next reading: " + moment(nextReading(msg.dateString)).format("lll")
          );

          $("#countdown").html(
            "Time until next reading: " + countdownTime(msg.dateString)
          );

          myChart.data.labels.push(moment(msg.dateString).format("hh:mm a"));
          myChart.data.datasets[0].data.push(msg.sgv);
          myChart.update();
        });
      });
    </script>
  </body>
</html>
